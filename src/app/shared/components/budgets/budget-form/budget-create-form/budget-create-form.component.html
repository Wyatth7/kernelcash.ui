<div [formGroup]="form()">
  <p-stepper [(value)]="activeStep" [linear]="true">
    <p-step-item [value]="FormStep.Start">
      <p-step>
        <ng-template #content let-activateCallback="activateCallback" let-value="value">
          <kc-icon-step (activated)="activateCallback()" icon="pi-calendar" [activeStep]="activeStep" [value]="value" />
        </ng-template>
      </p-step>
      <p-step-panel>
        <ng-template #content let-activateCallback="activateCallback">
          <div class="py-6">
            <div class="flex flex-col gap-2 mb-10">
              <h3 class="text-2xl">Name your budget</h3>
              <p class="m-0 p-0 text-gray-400">Give your budget a name to begin. You can change this at any time.</p>
            </div>
            <div class="flex flex-col gap-1">
              <label for="budgetName">Budget Name</label>
              <input pInputText id="budgetName" placeholder="October" formControlName="budgetName" />
            </div>
            <div class="flex gap-2 mt-1">
              <div class="flex-1 w-full">
                <label class="block mb-2">Start Date</label>
                <p-fluid>
                  <p-datepicker [maxDate]="form().controls.endDate.value"
                                formControlName="startDate" [iconDisplay]="'input'" [showIcon]="true" inputId="icondisplay" />
                </p-fluid>
              </div>
              <div class="flex-1">
                <label class="block mb-2">End Date</label>
                <p-fluid>
                  <p-datepicker [minDate]="form().controls.startDate.value" formControlName="endDate" [iconDisplay]="'input'" [showIcon]="true" inputId="icondisplay" />
                </p-fluid>
              </div>
            </div>

            <p-button
              [disabled]="form().controls.budgetName.invalid || form().controls.startDate.invalid || form().controls.endDate.invalid"
              styleClass="mt-8"
              label="Next"
              (onClick)="activateCallback(FormStep.Income)" />
          </div>
        </ng-template>
      </p-step-panel>
    </p-step-item>

    <p-step-item [value]="FormStep.Income">
      <p-step>
        <ng-template #content let-activateCallback="activateCallback" let-value="value">
          <kc-icon-step (activated)="activateCallback()" icon="pi-plus-circle" [activeStep]="activeStep" [value]="value" />
        </ng-template>
      </p-step>
      <p-step-panel>
        <ng-template #content let-activateCallback="activateCallback">
          <div class="py-6">

          <div class="flex flex-col gap-2 mb-10">
            <h3 class="text-2xl">Add your income</h3>
            <p class="m-0 p-0 text-gray-400">
              Split your income into special buckets such as paycheck 1/2, paycheck 2/2,
              pressure washing business, and cleaning business.
            </p>
          </div>
            <kc-spending-bucket-array-input
              defaultCategory="Income"
              [requireCategory]="false"
              [spendingBucketFormArray]="form().controls.incomeSpendingBuckets"
              namePlaceholder="Paycheck, Side Hustle, ect." />
          <div class="flex gap-2 mt-6">
            <p-button label="Back" severity="secondary" (onClick)="activateCallback(FormStep.Start)" />
            <p-button [disabled]="form().controls.incomeSpendingBuckets.invalid" label="Next" (onClick)="activateCallback(FormStep.Savings)"/>
          </div>
          </div>
        </ng-template>
      </p-step-panel>
    </p-step-item>

    <p-step-item [value]="FormStep.Savings">
      <p-step>
        <ng-template #content let-activateCallback="activateCallback" let-value="value">
          <kc-icon-step (activated)="activateCallback()" icon="pi-bookmark-fill" [activeStep]="activeStep" [value]="value" />
        </ng-template>
      </p-step>
      <p-step-panel>
        <ng-template #content let-activateCallback="activateCallback">
          <div class="py-6">

            <div class="flex flex-col gap-2 mb-10">
              <h3 class="text-2xl">Save for later</h3>
              <p class="m-0 p-0 text-gray-400">
                Save the money you make for trips, gifts, large purchases, or emergencies.
                It is recommended to save 30% of your income per-year, and have at least 3-6 months
                of income saved for emergencies.
              </p>
            </div>
            <kc-spending-bucket-array-input
              defaultCategory="Savings"
              [requireCategory]="false"
              [spendingBucketFormArray]="form().controls.savingSpendingBuckets"
              namePlaceholder="Emergency Fund, Vacation Fund, ect." />
            <p
              class="-mt-7 p-0 mb-6"
              [ngClass]="{
                  'text-emerald-300': !expenseComparison().invalid,
                  'text-red-400': expenseComparison().invalid
               }"
            >Remaining: {{expenseComparison().value | currency}}</p>
            <div class="flex gap-2 mt-6">
              <p-button label="Back" severity="secondary" (onClick)="activateCallback(FormStep.Income)" />

              @if (form().controls.savingSpendingBuckets.length == 1 && form().controls.savingSpendingBuckets.invalid) {
                <p-button
                  label="Skip"
                  severity="danger"
                  (onClick)="skipSavingsBucket(activateCallback)"
                  pTooltip="We recommend saving 30% of your income for emergencies." />
              } @else {
                <p-button [disabled]="form().controls.incomeSpendingBuckets.invalid" label="Next" (onClick)="activateCallback(FormStep.Expenses)"/>
              }
            </div>
          </div>
        </ng-template>
      </p-step-panel>
    </p-step-item>

    <p-step-item [value]="FormStep.Expenses">
      <p-step>
        <ng-template #content let-activateCallback="activateCallback" let-value="value">
          <kc-icon-step (activated)="activateCallback()" icon="pi-minus-circle" [activeStep]="activeStep" [value]="value" />
        </ng-template>
      </p-step>
      <p-step-panel>
        <ng-template #content let-activateCallback="activateCallback">
          <div class="py-6">

            <div class=" flex flex-col gap-2 mb-10">
              <h3 class="text-2xl">Add your expenses</h3>
              <p class="m-0 p-0 text-gray-400">
                Split your expenses into special buckets such as groceries,
                insurance, mortgage/rent, and entertainment.
              </p>
            </div>
            <kc-spending-bucket-array-input [spendingBucketFormArray]="form().controls.expenseSpendingBuckets" namePlaceholder="Groceries, Insurance, ect." />
            <p
              class="-mt-7 p-0 mb-6"
              [ngClass]="{
                  'text-emerald-300': !expenseComparison().invalid,
                  'text-red-400': expenseComparison().invalid
               }"
            >Remaining: {{expenseComparison().value | currency}}</p>
            <div class="flex gap-2 flex-row">
              <p-button label="Back" severity="secondary" (onClick)="navigateToSavings(activateCallback)" [disabled]="formSubmitting()" />
              <p-button
                [disabled]="form().controls.expenseSpendingBuckets.invalid || form().invalid || formSubmitting()"
                label="Finish"
                [icon]="formSubmitting() ? 'pi pi-spin pi-spinner' : 'pi pi-check'"
                severity="success"
                (click)="submitBudget(activateCallback)"/>
            </div>
          </div>
        </ng-template>
      </p-step-panel>
    </p-step-item>
    <p-step-item [value]="FormStep.ImportTransactions">
      <p-step>
        <ng-template #content let-activateCallback="activateCallback" let-value="value">
          <kc-icon-step (activated)="activateCallback()" icon="pi-file-import" [activeStep]="activeStep" [value]="value" />
        </ng-template>
      </p-step>
      <p-step-panel>
        <ng-template #content let-activateCallback="activateCallback">
          <div class="py-6">
            <div class=" flex flex-col gap-2">
              <p-message class="mb-2" severity="success">Success! Your budget has been created.</p-message>
              <h3 class="text-2xl">Get started faster</h3>
              <p class="m-0 p-0 text-gray-400">
                Automatically import transactions from your bank accounts.
                Your transactions will automatically appear in your budget.
              </p>
              <p class="mt-4 p-0 text-gray-400">
                Click "Go to budget" below to skip importing your transactions.
                You can import your transactions later.
              </p>
            </div>
            <div class="mt-4">
              <kc-import-transactions
                (uploadStarted)="transactionsUploading.set(true)"
                (uploadComplete)="transactionsUploading.set(false)"
              />
            </div>
            <div class="flex gap-2 mt-10">
              <p-button
                [disabled]="transactionsUploading()"
                label="Go to budget"
                icon="pi pi-check"
                severity="success"
                (click)="navigateToBudgetPage()"/>
            </div>
          </div>
        </ng-template>
      </p-step-panel>
    </p-step-item>
  </p-stepper>
</div>
